<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Brainchop </title>

  <link rel="apple-touch-icon" sizes="180x180"
    href="{{ url_for('static', filename='css/favicon_io/apple-touch-icon.png')}}">

  <link rel="icon" type="image/png" sizes="16x16"
    href="{{ url_for('static', filename='css/favicon_io/favicon-32x32.png')}}">
  <link rel="icon" type="image/png" sizes="16x16"
    href="{{ url_for('static', filename='css/favicon_io/favicon-16x16.png')}}">

  <link rel="manifest" href="{{ url_for('static', filename='css/favicon_io/site.webmanifest')}}">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/w3.css')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/font-awesome-4.7.0/css/font-awesome.min.css')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='js/libs/webix/codebase/webix.css')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='js/libs/papaya_lib/papaya.css')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css')}}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/brainchop.css')}}" />




  <script src="{{ url_for('static', filename='js/libs/lodash/lodash.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/jquery-3.3.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/jquery-3.2.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/opencv.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/image.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/webix/codebase/webix.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/tf.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/float16.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/papaya_lib/papaya.js') }}"></script>

  <script src="{{ url_for('static', filename='js/libs/nifti-reader.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/nifti-reader-min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/brainchop/connectedComponents3DAll.js') }}"></script>
  <script src="{{ url_for('static', filename='js/brainchop/mainParameters.js') }}"></script>
  <script src="{{ url_for('static', filename='js/brainchop/mainMeshNetFunctions.js') }}"></script>
  <script src="{{ url_for('static', filename='js/brainchop/mainNiftiReadingFunctions.js') }}"></script>
  <script src="{{ url_for('static', filename='js/brainchop/mainTypes.js') }}"></script>


  <script src="{{ url_for('static', filename='js/brainchop/checkCompatibility.js') }}"></script>

  <script src="{{ url_for('static', filename='js/libs/utilities.js') }}"></script>
  <script src="{{ url_for('static', filename='js/libs/pyodide.js') }}"></script>

  <script src="{{ url_for('static', filename='js/brainchop/mri_convert.js') }}"></script>

  <script type="text/javascript"
    src="{{ url_for('static', filename='js/libs/webix/components/edge/highcharts/hcharts.js') }}"></script>
  <script type="text/javascript" charset="UTF-8"
    src="{{ url_for('static', filename='js/libs/three/three.js') }}"></script>
  <script type="text/javascript" charset="UTF-8"
    src="{{ url_for('static', filename='js/libs/three/controls/TrackballControls.js') }}"></script>
  <script type="text/javascript" charset="UTF-8"
    src="{{ url_for('static', filename='js/libs/three/controls/OrbitControls.js') }}"></script>

  <script type="text/javascript" src="{{ url_for('static', filename='js/libs/util/Stats.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/libs/util/dat.gui.min.js') }}"></script>

  <script type="text/javascript" src="{{ url_for('static', filename='js/libs/util.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/brainchop/BCBrain3D.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/default.css')}}" />

  <style>
    /*For Testing*/
  </style>


</head>

<body>

  <script type="text/javascript">


    webix.ready(function () {
      // About Window
      let aboutWindowForm = {
        view: "form", id: "aboutWindowFormId", elements: [

          {
            cols: [
              {
                view: "template", template: "Brainchop is an in-browser  automatic segmentation setup for T1 MRI volumes. The tool is an open source and designed to enable users to segment T1 images into regions of interest with a simple interactive interface. The input must be a T1 brain volume in the Nifti format. The output can also be saved as a Nifti file. <br><br> <br><b>Authors:</b> Mohamed Masoud, Farfalla Hu and Sergey Plis (2023).<br> <b>Version:</b> 1.4.0 <br> <b>Funded by:</b>  NIH RF1MH121885. <br><br> <b>Special thanks</b> to Kevin Wang and Alex Fedorov for discussions and pre-trained Meshnet models.<br><br> <b>Affiliation: </b> Center for Translational Research in Neuroimaging and Data Science (<a href='https://trendscenter.org/'>TReNDS</a>) <br><center><img src='css/logo/TReNDS_logo.jpg' width='180' height='60'></img></center>"

              }

            ]

          },

          {
            cols: [
              {},

              {
                view: "button", value: "Ok", css: "bt_1", width: 100,
                align: "center",
                click: function () {
                  $$("aboutWindow").hide();
                }
              },

              {}
            ]
          }

        ]
      }

      // About Window to select local model
      webix.ui({
        view: "window",
        id: "aboutWindow",
        height: 550,
        width: 600,

        head: {
          view: "toolbar", css: "toolbarclass", elements: [
            { type: "header", template: "About", css: "windowtitleclass" },
            {
              view: "icon", icon: "wxi-close", click: function () {
                $$("aboutWindow").hide();
              }
            }
          ]
        },

        position: "center",
        body: aboutWindowForm

      })


      let about = "Demo of 3D MRI Segmentation. <br>By<br> Mohamed Masoud, Sergey Plis (2021) <br> Grant:  NIH RF1MH121885 ";

      aboutClick = () => {
        $$("aboutWindow").show()
      }


      feedbackClick = () => {
        window.open("https://forms.gle/WzUyVEzgCCY2bHo79");
      }

      githubClick = () => {
        window.open("https://github.com/neuroneural/brainchop");
      }

      toolbar = {
        view: "toolbar",
        css: "toolbarclass",
        id: "myToolbar",
        rows: [{
          cols:
            [
              { view: "label", label: '<img src="css/svg/Artboard2.svg"/>', css: { "color": "black !important", "font-weight": "bold" }, width: 30 },
              { view: "label", label: '<p>Brain<span>chop</span></p>', css: { "margin": "0!important" }, inputWidth: 100, align: "left" },
              {
                view: "label", label: '<i id="feedbackId" class="fa fa-pencil-square-o"/>',
                css: { "color": "black !important", "font-weight": "bold" }, width: 60, align: "right", click: feedbackClick, tooltip: "Feedback"
              },
              { view: "button", id: "About", value: "About", css: "bt_1", width: 100, align: "right", click: aboutClick },
              {
                view: "label", label: '',
                css: { "color": "black !important", "font-weight": "bold" }, width: 80, align: "right", click: githubClick, tooltip: "GitHub"
              },
            ]
        }
        ]
      }

      closeMriConvPrgBarWin = () => {
        $$("mriConvPrgBarWin").hide();
      }


      // Progress bar for mri_convert.js
      webix.ui({
        view: "window",
        id: "mriConvPrgBarWin",
        height: 50,
        width: 500,
        position: "center",
        head: false,
        body: {
          template: "  <div class='w3-container' style='margin-top: 1vh;' id='mriConvertProgBarDiv' > <div class='w3-border' > <div class='w3-green' style='height:2vh;width:0%;' id='mriConvertProgBar'></div> </div> </div> "
        }
      });



      //--------------Preprocessing Options -------------//
      clearInputThreejsWin = () => {
        if (inputSceneRendered) {
          clearScene(inputScene);
          input_gui.domElement.style.display = "none";
          inputSceneRendered = false;
        }

        $$("inputThreejsWinId").hide();
      }


      showInputPreprocessWindow = () => {
        var defer = $.Deferred();
        $$("inputThreejsWinId").show();

        if (!inputSceneRendered) { // if false,  render 
          document.getElementById("inputLoadingIconDiv").style.display = "";
        } else {
          document.getElementById("inputLoadingIconDiv").style.display = "none";
        }

        setTimeout(function () {
          defer.resolve(); // When this fires, the code in a().then(/..../); is executed.
        }, 100);

        return defer;
      }


      let inputOptions = {
        view: "form", id: "inputOptionsId", elements: [

          {
            cols: [
              {
                view: "label", label: "Input 3D (Enhancement)",
                id: "preprocessId",
                align: "left"
              },

              {
                view: "label",
                id: "inputPrepIcon",
                label: '<i class="fa fa-cube fa-lg" aria-hidden="true" id="preprocessIcon" style="opacity:0.9;filter:alpha(opacity=90);"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                disabled: false,
                click: function () {

                  showInputPreprocessWindow().then(res => {
                    if (!inputSceneRendered) { // if false, will render scene and gui

                      // Convert niftiImage arrayBuffer to array
                      //-- let imageDataFlat1D = new Uint8Array(niftiImage);
                      //-- imageDataFlat1D = [...imageDataFlat1D];

                      let imageDataFlat1D = arrayBuffer2Array(niftiImage, niftiHeader.datatypeCode);

                      // -- tf.tensor(imageDataFlat1D).max().print()

                      if (!isNiftiFileVerified(niftiHeader)) { // To render also non-sampled MRI
                        imageDataFlat1D = tf.tidy(() => {
                          //Round image data
                          let imageDataTensor = tf.round(tf.tensor1d(imageDataFlat1D));
                          //Normalize image data
                          return tensor2Array(tf.round(tf.mul(normalizeVolumeData(imageDataTensor), tf.scalar(255))));
                        });
                      }

                      // convert to 3D                 // <<<<<<<<<<<<<<<<<<<<<<<<<<<  256 256 256
                      let numSlices = niftiHeader.dims[3];
                      let sliceHeight = niftiHeader.dims[2];
                      let sliceWidth = niftiHeader.dims[1];

                      let input = tf.tensor(imageDataFlat1D, [numSlices, sliceHeight, sliceWidth]).reverse(1).arraySync();

                      let colorLutObj = {};

                      // Find voxel values frequency
                      let labelsHistogramMap = arrValuesFreq(imageDataFlat1D);

                      // Convert map to object 
                      let labelsHistoObj = map2Object(labelsHistogramMap);
                      delete labelsHistoObj['0'];

                      Object.keys(labelsHistoObj).forEach((labelKey, idx) => {
                        colorLutObj[labelKey] = "rgb(" + labelKey + "," + labelKey + "," + labelKey + ")";
                      })

                      // clearScene(scene)

                      initInput(input, "inputThreejsWinId", 'input-threejs-container', "input_gui_container", "inputLoadingIconDiv", rawNiftiData, niftiImage, colorLutObj);

                      inputSceneRendered = true;


                    } else { // if already rendered
                      input_gui.domElement.style.display = "";
                    }
                  })

                }
              }

            ]
          },


        ]
      }

      // Welcome Window
      let inputThreejsWinForm = {
        view: "form", id: "inputThreejsWinFormId", elements: [

          {
            cols: [
              {
                view: "template", template: "  <div id='input-threejs-container'> <div id='input_gui_container'></div> <div id='inputLoadingIconDiv' class ='panel' style='top: 50%; left: 50%; ' >  <i id='inputLoadingIcon' style='font-size:1.4vw; color: gray; background-color: rgba(0,0,0,0);'  class='w3-xxxlarge w3-spin fa fa-refresh' ></i> </div> </div> <div id='progressLine' class='progress-line'></div>",

              }
            ]
          },
          {
            cols: [
              {},

              {
                view: "button", id: "inputApplyId", value: "Apply", css: "bt_1", width: 100,
                align: "center",
                disabled: true
              },

              {
                view: "button", value: "Cancel", css: "bt_1", width: 100,
                align: "center",
                click: function () {
                  $$("inputThreejsWinId").hide();
                }
              },

              {
                view: "button", id: "inputSaveId", value: "Save Copy", css: "bt_1", width: 100,
                align: "center",
                disabled: true
              },

              {}
            ]
          }

        ]
      }

      webix.ui({
        view: "window",
        id: "inputThreejsWinId",
        height: Math.round(window.innerHeight * 0.7),
        width: Math.round(window.innerWidth * 0.7),
        move: true,
        resize: true,
        //width:400,
        head: {
          view: "toolbar", css: "toolbarclass", elements: [
            { type: "header", template: "Input Enhancement", css: "windowtitleclass" },
            {
              view: "icon", icon: "wxi-close", click: function () {
                $$("inputThreejsWinId").hide();
                input_gui.domElement.style.display = "none";
              }
            }
          ]
        },
        position: "center",
        body: inputThreejsWinForm
        // body:{
        //      // create custom list with checkboxes for different ROI.
        //      template:"  <div id='input-threejs-container'> <div id='input_gui_container'></div> <div id='inputLoadingIconDiv' class ='panel' style='top: 50%; left: 50%; ' >  <i id='inputLoadingIcon' style='font-size:1.4vw; color: gray; background-color: rgba(0,0,0,0);'  class='w3-xxxlarge w3-spin fa fa-refresh' ></i> </div> </div> "
        // }
      }
      )

      //-----------------Output 3D Options------------------// 

      clearOutputThreejsWin = () => {
        if (outputSceneRendered) {
          clearScene(outputScene);
          output_gui.domElement.style.display = "none";
          document.getElementById('roiList').style.display = "none";
          document.getElementById('roiItems').innerHTML = '';
          outputSceneRendered = false;
        }

        $$("outputThreejsWinId").hide();
      }

      webix.ui({
        view: "window",
        id: "outputThreejsWinId",
        height: Math.round(window.innerHeight * 0.7),
        width: Math.round(window.innerWidth * 0.7),
        move: true,
        resize: true,
        //width:400,
        head: {
          view: "toolbar", css: "toolbarclass", elements: [
            { type: "header", template: "3D Segmentation Regions", css: "windowtitleclass" },
            {
              view: "icon", icon: "wxi-close", click: function () {
                $$("outputThreejsWinId").hide();
                output_gui.domElement.style.display = "none";
              }
            }
          ]
        },

        position: "center",


        body: {
          //-- create custom list with checkboxes for different ROI.
          template: "  <div id='output-threejs-container'> <div id='output_gui_container'></div>    <div id='roiList' class='dropdown-check-list'> <span class='anchor'><p style='color:white; font-size:0.6vw; margin-top: 0em; margin-bottom: 0em;'>Select_ROI</p></span>  <ul id='roiItems' class='items'></ul> </div>  <div id='loadingIconDiv' class ='panel' style='top: 50%; left: 50%; ' > <i id='loadingIcon' style='font-size:1.4vw; color: gray; background-color: rgba(0,0,0,0);'  class='w3-xxxlarge w3-spin fa fa-refresh' ></i> </div>    </div> "
        }
      })


      //-----------------Open Brain T1 MRI ----------------------------------//  
      let chart_icon_url = "{{ url_for('static', filename='css/svg/outChart-1.svg')}}";
      let view3d_icon_url = "{{ url_for('static', filename='css/svg/out3D-1.svg')}}";
      let info_icon_url = "{{ url_for('static', filename='css/svg/info-circle-solid.svg')}}";

      let referenceImage = {
        view: "form", id: "referenceImage", elements: [
          {
            cols: [
              {
                view: "label", label: "Results Display Options",
                align: "left"
              },
              {
                view: "label",
                id: "outChartIcon",
                label: '<img src="' + chart_icon_url + '" id="outChart-1" style="opacity:0.3;filter:alpha(opacity=30);"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                disabled: true,
                click: function () {

                  $$("labelsHistogramWinId").show();

                }
              },
              {
                view: "label",
                id: "out3DIcon",
                label: '<img src="' + view3d_icon_url + '" id="out3D-1" style="opacity:0.3;filter:alpha(opacity=30);"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                disabled: true,
                click: function () {
                  //-- $$("outputThreejsWinId").show(); 
                  showThreejsWindow().then(res => {
                    if (!outputSceneRendered) { // if false, will render scene and gui

                      init(outVolumeStatus['out3DArr'], "outputThreejsWinId", 'output-threejs-container', "output_gui_container", outVolumeStatus['colorLutObj'], outVolumeStatus['labelsObj']);

                      outputSceneRendered = true;
                      document.getElementById("loadingIconDiv").style.display = "none";

                    } else { // if already rendered
                      output_gui.domElement.style.display = "";
                    }
                  })
                }
              },
              {
                view: "label",
                label: '<img src="' + info_icon_url + '"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                click: function () {
                  getOutputInfo();
                }
              },
            ]
          },
          {
            cols: [

              {
                view: "label", label: "Load NIfTI Files",
                align: "left"
              },

              {
                view: "uploader", value: "T1", width: 100, id: "imageUploader",
                css: "bt_1",
                align: "left",
                accept: "image/nii, image/nii.gz",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    //--file{name: "test.nii", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (file["name"].search(".nii") > 0) {

                      refFileName = file["name"];

                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);

                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }

                          params_mri["files"] = [file];
                          // Or
                          //params_mri["binaryImages"] = [event.target.result];

                          // Set 0 for MRI viewer 
                          papaya.Container.resetViewer(0, params_mri);
                          papaya.Container.atlas = null;
                          // Set 1 for label viewer, need this step to remove startup image
                          // papaya.Container.resetViewer(1);
                          papayaContainers[2].viewer.resetViewer();
                          papayaContainers[2].viewer.canvas.removeEventListener('mousemove', mouseMoveHandler);
                          papayaContainers[2].viewer.canvas.removeEventListener('mouseout', mouseOutHandler);

                          let startTime = performance.now();
                          // decompress/check uploaded Nifti data
                          rawNiftiData = getNiftiRawData(event.target.result);

                          if (rawNiftiData == null) {
                            let loadingErrorTxt = "This file not Nifti or corrupted. Please try again";

                            webix.alert({
                              type: "alert-error",
                              width: "35%",
                              text: loadingErrorTxt
                            });

                            $$("segmentBtn").disable();
                            // Disable input 3d preprocess button
                            //$$("inputPrepIcon").disable();
                            //document.getElementById("preprocessIcon").style.opacity = 0.3;
                            //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=30)";
                            return 0;
                          }

                          // If new MRI loaded, clear last 3D window if rendered before.
                          clearInputThreejsWin();
                          //$$("inputPrepIcon").enable();
                          //document.getElementById("preprocessIcon").style.opacity = 0.9;
                          //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=90)";

                          niftiHeader = readNiftiHeader(rawNiftiData);
                          niftiImage = readNiftiImageData(niftiHeader, rawNiftiData);


                          statData["Data_Load"] = ((performance.now() - startTime) / 1000).toFixed(4);
                          statData["Resampled"] = null;

                          statData["File_Type"] = nifti.isNIFTI1(rawNiftiData) ? "NIFTI-1" : nifti.isNIFTI2(rawNiftiData) ? "NIFTI-2" : "NOT-NIFTI";
                          statData["Img_Size"] = JSON.stringify([niftiHeader.dims[1], niftiHeader.dims[2], niftiHeader.dims[3]]);
                          statData["Num_Bits_Per_Voxel"] = niftiHeader['numBitsPerVoxel'];
                          statData["Data_Type_Code"] = niftiHeader['datatypeCode'];
                          statData["Vox_Offset"] = niftiHeader['vox_offset'];
                          statData["Vox_1mm"] = isVoxelSize1mm(niftiHeader);
                          statData["File_Verified"] = isNiftiFileVerified(niftiHeader);
                          //-- Check if Nifti file is already converted and no need to mri_convert.js

                          loadedMRI = true;
                          if (checkGPU()) {
                            $$("segmentBtn").enable();

                          }

                          numOfOverlays = 0;
                          $$("downloadBtn").disable();
                          $$("out3DIcon").disable();
                          $$("outChartIcon").disable();
                          document.getElementById("out3D-1").style.opacity = 0.3;
                          document.getElementById("outChart-1").style.opacity = 0.3;
                          document.getElementById("out3D-1").style.filter = "alpha(opacity=30)";
                          document.getElementById("outChart-1").style.filter = "alpha(opacity=30)";
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select Nifti file *.nii / *.nii.gz")

                    }
                    return false;
                  }
                }
              },
              {
                view: "uploader", value: "Labels", width: 100, id: "imageUploader1",
                css: "bt_1",
                align: "left",
                accept: "image/nii, image/nii.gz",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    //--file{name: "test.nii", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (file["name"].search(".nii") > 0) {

                      //refFileName = file["name"];

                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);



                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }

                          params_mri["files"].push(file);
                          // Or
                          //params_mri["binaryImages"].push(event.target.result);

                          //var labelArrayBuffer = createNiftiOutArrayBuffer(rawNiftiData, event.target.result);

                          // Set 0 for MRI viewer 

                          papaya.Container.atlas = null;
                          // Set 1 for label viewer, need this step to remove startup image
                          // papaya.Container.resetViewer(1);

                          let startTime = performance.now();
                          // decompress/check uploaded Nifti data
                          rawNiftiData = getNiftiRawData(event.target.result);

                          if (rawNiftiData == null) {
                            let loadingErrorTxt = "This file not Nifti or corrupted. Please try again";

                            webix.alert({
                              type: "alert-error",
                              width: "35%",
                              text: loadingErrorTxt
                            });

                            $$("segmentBtn").disable();
                            // Disable input 3d preprocess button
                            //$$("inputPrepIcon").disable();
                            //document.getElementById("preprocessIcon").style.opacity = 0.3;
                            //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=30)";
                            return 0;
                          }

                          // If new MRI loaded, clear last 3D window if rendered before.
                          clearInputThreejsWin();
                          //$$("inputPrepIcon").enable();
                          //document.getElementById("preprocessIcon").style.opacity = 0.9;
                          //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=90)";

                          niftiHeader = readNiftiHeader(rawNiftiData);
                          niftiImage = readNiftiImageData(niftiHeader, rawNiftiData);

                          let intArray = arrayBuffer2Array(niftiImage, niftiHeader.datatypeCode)

                          // TODO: implement this better  --> lut construction
                          //var num_classes = 3//Math.max(...intArray)+1;
                          //var colors = getCustomColorTable(num_classes);
                          //params_mri[file["name"]] = {lut: colors.prototype, interpolation: false}


                          papaya.Container.resetViewer(0, params_mri);
                          outVolumeStatus['out3DArr'] = tf.tensor(intArray, [niftiHeader.dims[1], niftiHeader.dims[2], niftiHeader.dims[3]]).reverse(1).arraySync();
                          console.log(outVolumeStatus['out3DArr']);


                          let labelsHistogramMap = arrValuesFreq(intArray);
                          let labelsHistoObj = map2Object(labelsHistogramMap);
                          outVolumeStatus['labelsHistoObj'] = labelsHistoObj;

                          //--Remvoe background volume
                          delete labelsHistoObj['0'];
                          let totalTissueVol = 0;
                          Object.keys(labelsHistoObj).forEach((labelKey, idx) => {
                            //-- Make sure to delete labelsHistoObj['0'] before
                            totalTissueVol += labelsHistoObj[labelKey];
                          })

                          let colorLutObj = {};
                          let labelsObj = {};

                          let roiData = [];
                          let roiLabels = [];
                          let chartXaxisStep = 1;

                          Object.keys(labelsHistoObj).forEach((labelKey, idx) => {
                            colorLutObj[labelKey] = "rgb(" + labelKey + "," + labelKey + "," + labelKey + ")";
                            labelsObj[labelKey] = labelKey;
                          })


                          Object.keys(labelsHistoObj).forEach((labelKey, idx) => {
                            roiData.push({ y: labelsHistoObj[labelKey] * 1 / totalTissueVol, color: rgbToHex(getRgbObject(colorLutObj[labelKey])) });
                            if (idx == 0 || idx == Math.round(Object.keys(labelsHistoObj).length * opts.chartXaxisStepPercent) || idx == Object.keys(labelsHistoObj).length - 1) {
                              roiLabels[idx] = labelsObj[labelKey];
                            }

                          });

                          chartXaxisStep = Math.round(Object.keys(labelsHistoObj).length * opts.chartXaxisStepPercent);

                          outVolumeStatus['colorLutObj'] = colorLutObj;
                          // To only show All make label null
                          outVolumeStatus['labelsObj'] = null;

                          $$("hchart").config.settings.xAxis.categories = roiLabels;
                          $$("hchart").config.settings.xAxis.labels.step = chartXaxisStep;
                          $$("hchart").config.settings.series[0].data = roiData;
                          $$("hchart")._render();

                          statData["Data_Load"] = ((performance.now() - startTime) / 1000).toFixed(4);
                          statData["Resampled"] = null;

                          statData["File_Type"] = nifti.isNIFTI1(rawNiftiData) ? "NIFTI-1" : nifti.isNIFTI2(rawNiftiData) ? "NIFTI-2" : "NOT-NIFTI";
                          statData["Img_Size"] = JSON.stringify([niftiHeader.dims[1], niftiHeader.dims[2], niftiHeader.dims[3]]);
                          statData["Num_Bits_Per_Voxel"] = niftiHeader['numBitsPerVoxel'];
                          statData["Data_Type_Code"] = niftiHeader['datatypeCode'];
                          statData["Vox_Offset"] = niftiHeader['vox_offset'];
                          statData["Vox_1mm"] = isVoxelSize1mm(niftiHeader);
                          statData["File_Verified"] = isNiftiFileVerified(niftiHeader);
                          //-- Check if Nifti file is already converted and no need to mri_convert.js

                          loadedLabel = true;
                          if (checkGPU()) {
                            $$("segmentBtn").enable();

                          }

                          numOfOverlays++;
                          $$("downloadBtn").enable();
                          $$("out3DIcon").enable();
                          $$("outChartIcon").enable();
                          document.getElementById("out3D-1").style.opacity = 0.3;
                          document.getElementById("outChart-1").style.opacity = 0.3;
                          document.getElementById("out3D-1").style.filter = "alpha(opacity=30)";
                          document.getElementById("outChart-1").style.filter = "alpha(opacity=30)";
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select Nifti file *.nii / *.nii.gz")

                    }
                    return false;
                  }
                }
              }
            ]
          }
        ]
      }

      let referenceImage2 = {
        view: "form", id: "referenceImage2", elements: [
          {
            cols: [
              {
                view: "label", label: "Load NIfTI files",
                align: "left"
              },

              {
                view: "uploader", value: "T1", width: 100, id: "imageUploader2",

                css: "bt_1",
                // align: "left",
                accept: "image/nii, image/nii.gz",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    //--file{name: "test.nii", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (file["name"].search(".nii") > 0) {

                      refFileName2 = file["name"];

                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);

                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }

                          // params_mri["files"] = [file]; 
                          // Or
                          params_mri2["binaryImages"] = [event.target.result];

                          // Set 1 for MRI viewer 
                          papaya.Container.resetViewer(1, params_mri2);
                          papaya.Container.atlas = null;
                          // Set 3 for label viewer, need this step to remove startup image
                          // papaya.Container.resetViewer(3);
                          papayaContainers[3].viewer.resetViewer();
                          papayaContainers[3].viewer.canvas.removeEventListener('mousemove', mouseMoveHandler);
                          papayaContainers[3].viewer.canvas.removeEventListener('mouseout', mouseOutHandler);

                          let startTime = performance.now();
                          // decompress/check uploaded Nifti data
                          rawNiftiData2 = getNiftiRawData(event.target.result);

                          if (rawNiftiData2 == null) {
                            let loadingErrorTxt = "This file not Nifti or corrupted. Please try again";

                            webix.alert({
                              type: "alert-error",
                              width: "35%",
                              text: loadingErrorTxt
                            });

                            $$("segmentBtn").disable();
                            // Disable input 3d preprocess button
                            //$$("inputPrepIcon").disable();
                            //document.getElementById("preprocessIcon").style.opacity = 0.3;
                            //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=30)";
                            return 0;
                          }

                          // If new MRI loaded, clear last 3D window if rendered before.
                          clearInputThreejsWin();
                          //$$("inputPrepIcon").enable();
                          //document.getElementById("preprocessIcon").style.opacity = 0.9;
                          //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=90)";

                          niftiHeader2 = readNiftiHeader(rawNiftiData2);
                          niftiImage2 = readNiftiImageData(niftiHeader2, rawNiftiData2);

                          statData2["Data_Load"] = ((performance.now() - startTime) / 1000).toFixed(4);
                          statData2["Resampled"] = null;

                          statData2["File_Type"] = nifti.isNIFTI1(rawNiftiData2) ? "NIFTI-1" : nifti.isNIFTI2(rawNiftiData2) ? "NIFTI-2" : "NOT-NIFTI";
                          statData2["Img_Size"] = JSON.stringify([niftiHeader2.dims[1], niftiHeader2.dims[2], niftiHeader2.dims[3]]);
                          statData2["Num_Bits_Per_Voxel"] = niftiHeader2['numBitsPerVoxel'];
                          statData2["Data_Type_Code"] = niftiHeader2['datatypeCode'];
                          statData2["Vox_Offset"] = niftiHeader2['vox_offset'];
                          statData2["Vox_1mm"] = isVoxelSize1mm(niftiHeader2);
                          statData2["File_Verified"] = isNiftiFileVerified(niftiHeader2);
                          //-- Check if Nifti file is already converted and no need to mri_convert.js

                          loadedMRI2 = true;

                          if (checkGPU()) {
                            $$("segmentBtn").enable();
                          }

                          numOfOverlays = 0;
                          $$("downloadBtn").disable();
                          $$("out3DIcon").disable();
                          $$("outChartIcon").disable();
                          document.getElementById("out3D-1").style.opacity = 0.3;
                          document.getElementById("outChart-1").style.opacity = 0.3;
                          document.getElementById("out3D-1").style.filter = "alpha(opacity=30)";
                          document.getElementById("outChart-1").style.filter = "alpha(opacity=30)";
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select Nifti file *.nii / *.nii.gz")

                    }

                    return false;

                  }
                }
              },
              {
                view: "uploader", value: "Labels", width: 100, id: "imageUploader3",

                css: "bt_1",
                // align: "left",
                accept: "image/nii, image/nii.gz",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    //--file{name: "test.nii", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (file["name"].search(".nii") > 0) {

                      //refFileName = file["name"];

                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);

                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }

                          // params_mri["files"] = [file]; 
                          // Or
                          params_mri2["binaryImages"].push(event.target.result);

                          // Set 1 for MRI viewer 
                          papaya.Container.resetViewer(1, params_mri2);
                          console.log(params_mri2);
                          papaya.Container.atlas = null;
                          // Set 3 for label viewer, need this step to remove startup image
                          // papaya.Container.resetViewer(3);

                          let startTime = performance.now();
                          // decompress/check uploaded Nifti data
                          rawNiftiData2 = getNiftiRawData(event.target.result);

                          if (rawNiftiData2 == null) {
                            let loadingErrorTxt = "This file not Nifti or corrupted. Please try again";

                            webix.alert({
                              type: "alert-error",
                              width: "35%",
                              text: loadingErrorTxt
                            });

                            $$("segmentBtn").disable();
                            // Disable input 3d preprocess button
                            //$$("inputPrepIcon").disable();
                            //document.getElementById("preprocessIcon").style.opacity = 0.3;
                            //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=30)";
                            return 0;
                          }

                          // If new MRI loaded, clear last 3D window if rendered before.
                          clearInputThreejsWin();
                          //$$("inputPrepIcon").enable();
                          //document.getElementById("preprocessIcon").style.opacity = 0.9;
                          //document.getElementById("preprocessIcon").style.filter = "alpha(opacity=90)";

                          niftiHeader2 = readNiftiHeader(rawNiftiData2);
                          niftiImage2 = readNiftiImageData(niftiHeader2, rawNiftiData2);

                          statData2["Data_Load"] = ((performance.now() - startTime) / 1000).toFixed(4);
                          statData2["Resampled"] = null;

                          statData2["File_Type"] = nifti.isNIFTI1(rawNiftiData2) ? "NIFTI-1" : nifti.isNIFTI2(rawNiftiData2) ? "NIFTI-2" : "NOT-NIFTI";
                          statData2["Img_Size"] = JSON.stringify([niftiHeader2.dims[1], niftiHeader2.dims[2], niftiHeader2.dims[3]]);
                          statData2["Num_Bits_Per_Voxel"] = niftiHeader2['numBitsPerVoxel'];
                          statData2["Data_Type_Code"] = niftiHeader2['datatypeCode'];
                          statData2["Vox_Offset"] = niftiHeader2['vox_offset'];
                          statData2["Vox_1mm"] = isVoxelSize1mm(niftiHeader2);
                          statData2["File_Verified"] = isNiftiFileVerified(niftiHeader2);
                          //-- Check if Nifti file is already converted and no need to mri_convert.js

                          loadedLabel2 = true;

                          if (checkGPU()) {
                            $$("segmentBtn").enable();
                          }

                          numOfOverlays = 0;
                          $$("downloadBtn").disable();
                          $$("out3DIcon").disable();
                          $$("outChartIcon").disable();
                          document.getElementById("out3D-1").style.opacity = 0.3;
                          document.getElementById("outChart-1").style.opacity = 0.3;
                          document.getElementById("out3D-1").style.filter = "alpha(opacity=30)";
                          document.getElementById("outChart-1").style.filter = "alpha(opacity=30)";
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select Nifti file *.nii / *.nii.gz")

                    }

                    return false;

                  }
                }
              },

            ]
          }
        ]
      }

      // function to get masking model from inferenceModelsList
      getMaskingModels = () => {
        return ["", "Full Brain GWM (light)", "Full Brain GWM (large)"];
      }

      let modelBrowsingForm = {
        view: "form", id: "modelBrowsingFormId", elements: [
          {
            cols: [
              { view: "label", label: "Model*", align: "left" },
              { view: "icon", id: "modelIconId", icon: "", align: "left" },
              {
                view: "uploader", value: "Load", width: 100, id: "modelUploader",

                css: "bt_1",
                align: "left",
                accept: "application/json",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    modelFile = file;
                    console.log("modelFile :", modelFile)
                    //--file{name: "model.json", lastModified: 1548792883000, webkitRelativePath: "", size: 5030, type: ""}
                    if (modelFile["name"].search(".json") > 0) {
                      let reader = new FileReader();
                      let blob = makeSlice(file, 0, file.size);
                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                          $$("modelIconId").config.icon = "wxi-check";
                          $$("modelIconId").refresh();
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select model json file *.json")

                    }

                    return false;

                  }
                }
              }
            ]
          },

          {
            cols: [
              { view: "label", label: "Weights*", align: "left" },
              { view: "icon", id: "weightsIconId", icon: "", align: "left" },
              {
                view: "uploader", value: "Load", width: 100, id: "weightUploader",

                css: "bt_1",
                align: "left",
                accept: "application/bin",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    weightFile = file;
                    console.log("weightFile :", weightFile)
                    //--file{name: "weights.bin", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (weightFile["name"].search(".bin") > 0) {
                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);

                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                          $$("weightsIconId").config.icon = "wxi-check";
                          $$("weightsIconId").refresh();
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select weights binary file *.bin")

                    }

                    return false;
                  }
                }
              }
            ]
          },

          {
            cols: [
              { view: "label", label: "Labels", align: "left" },
              { view: "icon", id: "labelsIconId", icon: "", align: "left" },
              {
                view: "uploader", value: "Load", width: 100, id: "labelUploader",

                css: "bt_1",
                align: "left",
                accept: "application/json",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    labelFile = file;
                    console.log("labelFile :", labelFile)
                    //--file{name: "weights.bin", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (labelFile["name"].search(".json") > 0) {
                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);

                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                          $$("labelsIconId").config.icon = "wxi-check";
                          $$("labelsIconId").refresh();
                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select labels json file *.json")

                    }

                    return false;
                  }
                }
              }
            ]
          },

          {
            cols: [
              { view: "label", label: "Colors", align: "left" },
              { view: "icon", id: "colorsIconId", icon: "", align: "left" },
              {
                view: "uploader", value: "Load", width: 100, id: "colorUploader",

                css: "bt_1",
                align: "left",
                accept: "application/json",
                autosend: false,
                multiple: false,
                on: {
                  onBeforeFileAdd: function (upload) {
                    let file = upload.file;
                    colorFile = file;
                    console.log("colorFile :", colorFile)
                    //--file{name: "weights.bin", lastModified: 1548792883000, webkitRelativePath: "", size: 503010, type: ""}
                    if (colorFile["name"].search(".json") > 0) {
                      let reader = new FileReader();

                      var blob = makeSlice(file, 0, file.size);

                      reader.onloadend = function (event) {

                        if (event.target.readyState === FileReader.DONE) {
                          //--evt.target.result is :  ArrayBuffer { byteLength: 763810 }
                          $$("colorsIconId").config.icon = "wxi-check";
                          $$("colorsIconId").refresh();

                        }
                      };

                      reader.readAsArrayBuffer(blob);

                    } else {
                      webix.message("Select colors json file *.json")

                    }
                    return false;
                  }
                }
              }
            ]
          },

          {
            cols: [
              {
                view: "label", label: "Transpose Input",
                align: "left"
              },

              {
                view: "select",
                id: "transposeStatus",
                value: 1,
                options: ["true", "false"]
              },

              {
                view: "label",
                label: '<img src="css/svg/info-circle-solid.svg"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                click: function () {
                  let info = "Transpose Info"
                  $$("modelTooltip").show();
                  document.getElementById("tooltipDiv").innerHTML =
                    "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"

                }
              }

            ]
          },

          {
            cols: [
              {
                view: "label", label: "Crop Input",
                align: "left"
              },

              {
                view: "select",
                id: "cropStatus",
                value: 1,
                options: ["false", "true"],
                on: {
                  onChange: function (newValue, oldValue, config) {
                    if (newValue == "true") {
                      $$("cropPadStatus").enable();
                      $$("preModelStatus").enable();

                    } else {
                      $$("cropPadStatus").disable();
                      $$("cropPadStatus").setValue(0);
                      $$("preModelStatus").setValue("");
                      $$("filterByMaskStatus").setValue("false");
                    }

                  }
                }
              },

              {
                view: "label",
                label: '<img src="css/svg/info-circle-solid.svg"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                click: function () {
                  let info = "For speed-up the inference with limited browser memory, cropping brain from background before feeding the result to the inference model can lower memory use.";
                  $$("modelTooltip").show();
                  document.getElementById("tooltipDiv").innerHTML =
                    "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"
                }
              }

            ]
          },

          {
            cols: [
              {
                view: "label", label: "Crop Padding",
                align: "left"
              },

              {
                view: "select",
                id: "cropPadStatus",
                value: 0,
                disabled: true,
                options: ["0", "1", "2", "3"]
              },

              {
                view: "label",
                label: '<img src="css/svg/info-circle-solid.svg"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                click: function () {
                  let info = "Add Padding to cropped brain 3D image. ";
                  $$("modelTooltip").show();
                  document.getElementById("tooltipDiv").innerHTML =
                    "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"
                }
              }

            ]
          },

          {
            cols: [
              {
                view: "label", label: "Pre-Model Masking",
                align: "left"
              },

              {
                view: "select",
                id: "preModelStatus",
                value: 1,
                disabled: true,
                options: getMaskingModels(),
                on: {
                  onChange: function (newValue, oldValue, config) {
                    if (newValue !== "") {
                      $$("filterByMaskStatus").enable();

                    } else {
                      $$("filterByMaskStatus").disable();
                      $$("filterByMaskStatus").setValue("false");
                    }

                  }
                }

              },

              {
                view: "label",
                label: '<img src="css/svg/info-circle-solid.svg"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                click: function () {
                  let info = "Select a masking model for cropping the brain.";
                  $$("modelTooltip").show();
                  document.getElementById("tooltipDiv").innerHTML =
                    "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"
                }
              }


            ]
          },

          {
            cols: [
              {
                view: "label", label: "Filter Output by Mask",
                align: "left"
              },

              {
                view: "select",
                id: "filterByMaskStatus",
                disabled: true,
                value: 1,
                options: ["false", "true"]
              },

              {
                view: "label",
                label: '<img src="css/svg/info-circle-solid.svg"/>',
                css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
                width: 25,
                height: 25,
                click: function () {
                  let info = "This is a voxel-wise multiplication of resulted output and the mask resulted from the pre-model inference. This option can be used to clean any wrongly segmented regions (e.g. skull areas) but also it can result in removing some properly segmented regions."
                  $$("modelTooltip").show();
                  document.getElementById("tooltipDiv").innerHTML =
                    "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"
                }
              }

            ]
          },

          {
            cols: [
              {
                view: "label", label: "Model Name*",
                align: "left"
              },
              {
                view: "text",
                placeholder: "New Model ",
                id: "proposedModelName",
                disabled: false,
                align: "left"
              }
            ]
          },
          {
            cols: [
              {},
              {
                view: "button", value: "Confirm", css: "bt_1", width: 100,
                align: "center",
                click: function () {

                  if (modelFile && weightFile) {

                    let newId = parseInt(inferenceModelsList.at(-1)["id"]) + 1;
                    newId = newId.toString();

                    // Model list loaded from browsing
                    browserModelList.push({ id: newId, modelFile: modelFile, weightFile: weightFile, colorFile: colorFile, labelFile: labelFile });

                    let labelFileUrl = null;

                    if (browserModelList.at(-1)["labelFile"]) {
                      labelFileUrl = URL.createObjectURL(browserModelList.at(-1)["labelFile"]);
                    }

                    let colorFileUrl = null;

                    if (browserModelList.at(-1)["colorFile"]) {
                      colorFileUrl = URL.createObjectURL(browserModelList.at(-1)["colorFile"]);
                    }

                    let newModelName = "New Model " + newId;
                    if ($$("proposedModelName").getValue().length && isLetter($$("proposedModelName").getValue()[0])) {
                      newModelName = $$("proposedModelName").getValue().trim();
                      // Check new imported model name possible redundancy
                      if (inferenceModelsList.filter(entry => entry.modelName == newModelName).length) {
                        webix.message("Please select unique model name");
                        return 0;
                      }

                    } else if ($$("proposedModelName").getValue().length) {
                      webix.message("Please select valid model name");
                      return 0;
                    } else if (isLetter($$("proposedModelName").getValue()[0])) {
                      webix.message("Please select model name");
                      return 0;
                    }

                    let preModelIdVal = null;
                    if ($$("preModelStatus").getValue().length) {
                      preModelIdVal = inferenceModelsList.filter(entry => entry.modelName === $$("preModelStatus").getValue())[0].id;

                    }


                    inferenceModelsList.push({
                      id: newId,
                      type: "Segmentation",
                      path: null,
                      modelName: newModelName,
                      labelsPath: labelFileUrl,
                      colorsPath: colorFileUrl,
                      preModelId: preModelIdVal,
                      isBatchOverlapEnable: false,
                      numOverlapBatches: 0,
                      enableTranspose: $$("transposeStatus").getValue(),
                      enableCrop: $$("cropStatus").getValue(),
                      cropPadding: parseInt($$("cropPadStatus").getValue()),
                      filterOutWithPreMask: $$("filterByMaskStatus").getValue(),
                      textureSize: 0,
                      warning: null,
                      inferenceDelay: 100,
                      description: ""
                    })


                    selectModelOptions = getSegmentationFormOptions(inferenceModelsList);
                    $$("selectModel").config.options = selectModelOptions;
                    $$("selectModel").config.value = parseInt(newId);
                    $$("selectModel").refresh();

                    $$("modelBrowsingWindow").hide();
                    $$("proposedModelName").setValue("");


                  } else if (weightFile) {
                    webix.message("Please select the model json file");

                  } else {
                    webix.message("Please select the model weights file");
                  }
                }
              },
              {}
            ]
          }

        ]
      }

      // Model Browsing Window to select local model
      webix.ui({
        view: "window",
        id: "modelBrowsingWindow",
        height: 600,
        width: 400,
        head: {
          view: "toolbar", css: "toolbarclass", elements: [
            { type: "header", template: "Load tfjs Model", css: "windowtitleclass" },
            {
              view: "icon", icon: "wxi-close", click: function () {
                $$("modelBrowsingWindow").hide();
                $$("proposedModelName").setValue("");
              }
            }
          ]
        },

        position: "center",
        body: modelBrowsingForm
      })

      // Reset check icon
      $$("modelBrowsingWindow").attachEvent("onShow", function () {
        $$("weightsIconId").config.icon = "";
        $$("modelIconId").config.icon = "";
        $$("labelsIconId").config.icon = "";
        $$("colorsIconId").config.icon = "";
        $$("weightsIconId").refresh();
        $$("modelIconId").refresh();
        $$("labelsIconId").refresh();
        $$("colorsIconId").refresh();
        $$("cropStatus").setValue("false");
        modelFile = null;
        weightFile = null;
        labelFile = null;
        colorFile = null;
      });


      getSegmentationFormOptions = (modelsList) => {
        let selectedOptions = [];

        modelsList.forEach(function (modelEntry) {
          selectedOptions.push({ id: modelEntry["id"], value: modelEntry["modelName"], path: modelEntry["path"] });
        })

        selectedOptions.push({ id: "Browse...", value: "Browse...", path: null });

        return selectedOptions
      }

      // To load models dynamically from  inferenceModelsList
      let selectModelOptions = getSegmentationFormOptions(inferenceModelsList);
      console.log(selectModelOptions);
      let modelOptions = {{ available_models|tojson  }};
      modelOptions.push({ id: "Browse...", value: "Browse...", path: null });
      console.log(modelOptions);

    //-- Count total number of models excluding browsing models
    numOfModelsWithoutBrowse = inferenceModelsList.length;


    onShowWarningCheck = (checkElem) => {
      webix.storage.local.put("noShowWarning", document.getElementById("noShowWarningId").checked);
    }

    fetchModelWarningStatus = () => {
      return webix.storage.local.get("noShowWarning");
    }

    onShowTooltipCheck = (checkElem) => {
      webix.storage.local.put("noShowTooltip", document.getElementById("noShowTooltipId").checked);

    }

    fetchModelTooltipStatus = () => {
      return webix.storage.local.get("noShowTooltip");
    }

    getModelinfo = () => {
      let modelDescription = modelOptions[$$("selectModel").getValue()]["description"];
      let info = "No info for this model";

      if (modelDescription) {
        info = modelDescription;
      }

      $$("modelTooltip").show();
      document.getElementById("tooltipDiv").innerHTML =
        "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"
    }

    getOutputInfo = () => {


      let info = '<p>Icon <img src="' + chart_icon_url + '" style="opacity:0.3;filter:alpha(opacity=30);width:15px;height:15px;"/> allows to see the histogram of labels occurring in the segmentation.</p><p>Icon <img src="' + view3d_icon_url + '" style="opacity:0.3;filter:alpha(opacity=30);width:15px;height:15px;"/> allows to show a 3D view of the segmented labels.</p>';
      $$("modelTooltip").show();
      document.getElementById("tooltipDiv").innerHTML =
        "<i style='font-size:1.4vw'  class='fa fa-info-circle' ></i> <font style='font-size:0.77vw' >&nbsp&nbsp" + info + " </font>"
    }

    resestDependency = () => {
      //-- For future use
      document.getElementById("out3D-1").style.opacity = 0.3;
      document.getElementById("outChart-1").style.opacity = 0.3;
      document.getElementById("out3D-1").style.filter = "alpha(opacity=30)";
      document.getElementById("outChart-1").style.filter = "alpha(opacity=30)";
      //-- Reset papaya MRI viewer overlay if exists
      resetMriViewerOverlay(1);
      //-- Reset Label Viewer        
      resetLabelViewer();
      clearOutputThreejsWin();
      resetMainParameters();
    }

    disableControls = () => {
      $$("out3DIcon").disable();
      $$("outChartIcon").disable();
      $$("downloadBtn").disable();
      $$("segmentBtn").disable();
    }

    newRunInferencePrepare = () => {
      var defer = $.Deferred();
      disableControls();
      resestDependency();

      setTimeout(function () {
        defer.resolve(); // When this fires, the code in a().then(/..../); is executed.
      }, 100);

      return defer;
    }

    let info_circle_solid_url = "{{ url_for('static', filename='css/svg/info-circle-solid.svg')}}";

    let Segmentation = {
      view: "form", id: "Segmentation", elements: [
        {
          type: "header", template: "Segmentation Options",
          css: "headerclass"
        },

        {
          cols: [

            {
              view: "select",
              label: "Models",
              id: "selectModel",
              value: 0,
              options: modelOptions,
              on: {
                onChange: function (newValue, oldValue, config) {
                  if (newValue == "Browse...") {
                    console.log("Browse selected ..")
                    $$("modelBrowsingWindow").show();
                  }
                },
                onAfterRender: function () {

                }
              }
            },


            {
              view: "label",
              label: '<img src="' + info_circle_solid_url + '"/>',
              css: { "color": "black !important", "font-weight": "bold", "cursor": "pointer" },
              width: 25,
              height: 25,
              click: function () {
                getModelinfo();
              }
            }

          ]
        },

        {
          cols: [
            {
              view: "label", label: "Inference",
              id: "segmentBtnLabel",
              align: "left"
            },
            {
              view: "button", label: "Run",
              css: "bt_1",
              disabled: true,
              id: "segmentBtn",
              align: "left",
              click: function () {

                // test for requirement 
                let maxTextureAvail = getMaxTextureSize();
                let requiredTexture = inferenceModelsList[$$("selectModel").getValue() - 1]["textureSize"];
                if (maxTextureAvail >= requiredTexture) {

                  newRunInferencePrepare().then(res => { runInference(); })

                } else {
                  webix.alert("This model needs texture size of minimum " + requiredTexture + ", while current browser supports only " + maxTextureAvail);
                }
              }
            }
          ]
        },
        { content: "progressBarDiv", height: 50 }
        // { content: "subProgressBarDiv" , height:50},

      ]
    }


    //--------------------------------------------//
    //---------- Output Rendering ----------------//
    //--------------------------------------------//

    showThreejsWindow = () => {
      var defer = $.Deferred();
      $$("outputThreejsWinId").show();

      if (!outputSceneRendered) { // if false,  render 
        document.getElementById("loadingIconDiv").style.display = "";
      } else {
        document.getElementById("loadingIconDiv").style.display = "none";
      }

      setTimeout(function () {
        defer.resolve(); // When this fires, the code in a().then(/..../); is executed.
      }, 100);

      return defer;
    }

    let outputOptions = {
      view: "form", id: "OutputOptionsId", elements: [
        {
          cols: [
            {
              view: "label", label: "Output Volumes",
              id: "outChartLabel",
              align: "left"
            },



          ]
        },

        {
          cols: [
            {
              view: "label", label: "Output 3D",
              id: "out3DLabel",
              align: "left"
            },


          ]
        }
      ]
    }

    // Welcome Window
    let welcomeWindowForm = {
      view: "form", id: "welcomeWindowFormId", elements: [

        {
          cols: [
            {
              view: "template", template: " <img src='css/svg/Artboard2.svg'  width='20%' align='right'>" +
                " <p align='justify'> Welcome to brainchop, a" + " frontend" + " tool for  volumetric segmentation of neuroimaging that works locally on the user side.</p>" +
                " <p align='justify'> You're viewing a sample T1 (Left)  and its tissue segmentation (Right). Brainchop currenlty supports MRI Nifti file format. </p>" +
                "<p align='justify'> To see the tool in action please select a model from the list and run the inference. For more information on brainchop please refer to this <a href='https://github.com/neuroneural/brainchop/wiki/' target='_blank'><b> Wiki </b></a> and this <a href='https://trendscenter.org/in-browser-3d-mri-segmentation-brainchop-org/' target='_blank'><b> Blog</b></a>. For questions or sharing ideas please refere to our  <b><a href='https://github.com/neuroneural/brainchop/discussions/'  target='_blank'> Discussions </a></b> board. </p>" +
                " <center> <video id='advVideo' autoplay muted width='400' controls poster='css/images/BrainchopBanner.png'>  <source src='css/media/brainchopV1_3.mp4' type='video/mp4'>Your browser does not support the video tag</video> </center> <br>" +
                "<input type='checkbox' id='noShowWelcomeWindow'  name='noShowWelcomeWindow'><label for='noShowWelcomeWindow'><font color='black'>  Don't show again </font></label>",

              on: {
                onAfterRender: function () {
                  if (fetchWelcomeScreenStatus() == null || fetchWelcomeScreenStatus()) {
                    // document.getElementById('advVideo').muted = false; 
                  }

                }
              }

            }

          ]

        },


        {
          cols: [
            {},

            {
              view: "button", value: "Ok", css: "bt_1", width: 100,
              align: "center",
              click: function () {
                $$("welcomeWindow").hide();
                document.getElementById('advVideo').pause();
                webix.storage.local.put("showWelcomeScreen", !document.getElementById("noShowWelcomeWindow").checked);
              }
            },

            {}
          ]
        }

      ]

    }


    webix.ui({
      view: "popup",
      id: "modelTooltip",
      // head:"<i style='font-size:1.8vw'  class='fa fa-info-circle' ></i>",
      body: {
        template: "<div id='tooltipDiv'></div>"
      },
      position: function (state) {
        state.width = state.maxWidth * 20 / 100;
        state.height = state.maxHeight * 15 / 100;
        state.left = (state.maxWidth - state.width) / 1.01;
        state.top = (state.maxHeight - state.height) / 1.1;
      }

    });


    // Welcome Window to select local model
    webix.ui({
      view: "window",
      id: "welcomeWindow",
      height: 620,
      width: 600,
      head: {
        view: "toolbar", css: "toolbarclass", elements: [
          { type: "header", template: "Welcome", css: "windowtitleclass" },
          {
            view: "icon", icon: "wxi-close", click: function () {
              $$("welcomeWindow").hide();
              document.getElementById('advVideo').pause();
            }
          }
        ]
      },

      position: "center",
      body: welcomeWindowForm
    })


    fetchWelcomeScreenStatus = () => {
      return webix.storage.local.get("showWelcomeScreen");
    }

    if (fetchWelcomeScreenStatus() == null || fetchWelcomeScreenStatus()) {
      $$("welcomeWindow").show();
    } else {
      $$("welcomeWindow").hide();
    }




    let downloadNiftiFile = {
      view: "form", id: "downloadNiftiFileId", elements: [
        {
          type: "header", template: "Save Labels",
          css: "headerclass"
        },

        {
          cols: [
            {
              view: "label", label: "File Name",
              align: "left"
            },
            {
              view: "text",
              value: "labels.nii",
              id: "fileNameToDL",
              disabled: false,
              align: "left",
              on: {
                onChange: function (newValue, oldValue, config) {
                  if (newValue.length && allOutputSlices3DCC1DimArray.length && isLetter(newValue[0])) {
                    $$("downloadBtn").enable();
                  } else {
                    $$("downloadBtn").disable();
                  }

                }
              }
            }
          ]
        },

        {
          cols: [
            {
              view: "label", label: "Labels",
              align: "left"
            },
            {
              view: "button", label: "Save",
              id: "downloadBtn",
              css: "bt_1",
              disabled: true,
              align: "left",
              click: function () {

                if (allOutputSlices3DCC1DimArray.length) {
                  let downloadFileName = $$("fileNameToDL").getValue();

                  if (downloadFileName.search(".nii") < 0) {
                    // if nii extension doesn't exist, then search will return -1
                    downloadFileName = downloadFileName + ".nii";
                  }

                  downloadNifti(allOutputSlices3DCC1DimArray, rawNiftiData, downloadFileName);

                } else {
                  webix.message("No download Data");
                }
              }
            }
          ]
        }
      ]
    }


    let memoryView = {
      view: "chart",
      type: "barH",
      id: "memoryMonitor",
      width: 120,
      height: 10,
      value: "#memoryUse#",
      gradient: function (gradient) {
        gradient.addColorStop(1.0, "#FF0000");
        gradient.addColorStop(0.5, "#FFFF00");
        gradient.addColorStop(0.0, "#00FF22");
      },
      alpha: 0.8,
      radius: 2,
      border: false,
      xAxis: {
        start: 0,
        end: 100,
        step: 10,
        template: ""
      },
      yAxis: {
        template: ""
      }
    }


    let hardwareStatus = {
      view: "form", id: "hardwareStatusId", elements: [
        {
          type: "header", template: "Status",
          css: "headerclass"
        },

        {
          cols: [
            {
              view: "label", label: "WebGL-2", width: 70,
              align: "left"
            },
            {
              view: "label", label: "<span id='webGl2Status' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>", align: "left"
            },

            {
              view: "label", label: "Memory", width: 80,
              align: "right"
            },  // memoryView              
            {
              view: "label", label: "<span id='memoryStatus' style='background-color:none; padding-left:0.5vw;'>&nbsp&nbsp</span>", align: "right"
            }
          ]
        }
      ]
    }




    roiHChart = {
      type: "space", rows: [

        {
          id: "hchart", view: "highchart",
          modules: ["series-label", "exporting", "export-data", "accessibility"],
          settings: {
            chart: {
              type: 'column',
              width: 800,
              // height: 400,
              // marginLeft: 0,
              // marginRight: 0,
              scrollablePlotArea: {
                minWidth: 900,
                scrollPositionX: 1
              }
            },

            title: {
              text: ''
            },
            subtitle: {
              text: ''
            },
            credits: {
              enabled: false
            },
            plotOptions: {
              series: {
                borderWidth: 1,
                borderColor: 'black',
                maxPointWidth: 20
              },
              bar: {
                dataLabels: {
                  enabled: true
                }
              }
            },
            xAxis: {
              type: 'category',

              categories: null,
              labels: {
                rotation: -45,
                step: 1,
                style: {
                  fontSize: '10px',
                  fontFamily: 'Verdana, sans-serif'
                }
              }
            },

            yAxis: {
              min: 0,
              // max: 100,
              title: {
                text: "Histogram Probability"
                // align: 'high'
              }
            },

            legend: {
              enabled: false
            },

            series: [{
              name: 'volumes',
              data: null,

            }]
          }
        }
      ]
    };

    // Output labels histogram  form
    let histogramWindowForm = {
      view: "form", id: "histogramWindowFormId",
      elements: [
        roiHChart,

        {
          cols: [
            {},

            {
              view: "button", value: "Ok", css: "bt_1", width: 100,
              align: "center",
              click: function () {
                //debugger;
                $$("labelsHistogramWinId").hide();
              }
            },
            {
              view: "button", value: "Save Data", css: "bt_1", width: 100,
              align: "center",
              click: function () {

                let labelsHistoObj = outVolumeStatus['labelsHistoObj'];
                let fileName = refFileName == "" ? opts.uiSampleName : refFileName;
                downloadJsonObj(labelsHistoObj, fileName + "_Seg" + Object.keys(labelsHistoObj).length + "_volumes.json");

              }
            },

            {}
          ]
        }

      ]
    }

    // Output labels histogram Window 
    webix.ui({
      view: "window",
      id: "labelsHistogramWinId",
      height: 600,
      width: 800,
      move: true,
      resize: true,
      head: {
        view: "toolbar", css: "toolbarclass", elements: [
          { type: "header", template: "Output Labels", css: "windowtitleclass" },
          {
            view: "icon", icon: "wxi-close", click: function () {
              $$("labelsHistogramWinId").hide();
            }
          }
        ]
      },

      position: "center",
      body: histogramWindowForm

    })

    //-------------------------------------------------------//
    //-------------------------Main--------------------------//
    //-------------------------------------------------------// 

    webix.ui({
      margin: 5,
      rows: [
        //toolbar,
        {
          margin: 20,
          padding: 20,
          cols: [
            {
              width: 250, margin: 10, rows: [
                //referenceImage,
                //referenceImage2,
                //inputOptions,
                Segmentation,
                //outputOptions,
                downloadNiftiFile,
                hardwareStatus,
                {}
              ]
            },
            {
              rows: [
                {
                  type: "header", template: "MRI  Viewer",
                  css: "headerclass"
                },
                { view: "template", content: "papayaMriDiv", borderless: true },
                referenceImage,
              ]

            },
            {
              rows: [
                {
                  type: "header", template: "Comparative View",
                  css: "headerclass",
                },
                { view: "template", content: "papayaMriDiv2", borderless: true },
                referenceImage2
              ]
            }
          ]
        }],

    });

    //-- To excute immediately after window loading
    //-- 0 for MRI viewer, 2 for Label viewer
    papayaContainers[0].preferences.smoothDisplay = 'Yes';
    papayaContainers[2].preferences.smoothDisplay = 'No';

    //-- 1 for MRI viewer, 3 for Label viewer
    papayaContainers[1].preferences.smoothDisplay = 'Yes';
    papayaContainers[3].preferences.smoothDisplay = 'No';

    //--Activate annotation for papaya container 1- default    
    addMouseMoveHandler("./models/GT/labels.json", 1);


    document.getElementById(PAPAYA_CONTROL_MAIN_SWAP_BUTTON_CSS + papayaContainers[1].containerIndex).addEventListener("click", function () {
      papayaContainers[0].viewer.rotateViews()
    })

    // Check for possible wrongly report or duplicate models ids
    checkInferenceModelList();
    })
  </script>


  <div class="grid-container" id="papayaMriDiv">
    <div class="grid-item" id="divMri">
      <div class="papaya" data-params="params_mri"></div>
    </div>
    <div class="grid-item">
      <input type="text" id="annotOfContainer_0" disabled>
    </div>
  </div>

  <div class="grid-container" id="papayaMriDiv2">
    <div class="grid-item" id="divMri2">
      <div class="papaya" data-params="params_mri2"></div>
    </div>
    <div class="grid-item">
      <input type="text" id="annotOfContainer_2" disabled>
    </div>
  </div>

  <div class="grid-container" id="papayaLabelDiv" style="display: none;">
    <div class="grid-item">
      <div class="papaya" data-params="params_label"></div>
    </div>
    <div class="grid-item">
      <input type="text" id="annotOfContainer_1" disabled>
    </div>
  </div>

  <div class="grid-container" id="papayaLabelDiv2" style="display: none;">
    <div class="grid-item">
      <div class="papaya" data-params="params_label2"></div>
    </div>
    <div class="grid-item">
      <input type="text" id="annotOfContainer_3" disabled>
    </div>
  </div>



  <div class="w3-container" style="margin-top: 1vh;" id="progressBarDiv">
    <div class="w3-border">
      <div class="w3-blue" style="height:2vh;width:0%;" id="progressBar"></div>
    </div>
  </div>


  <div style="height: 0vh; width: 0vw;">
    <form method="post" autocomplete="off" name="google-sheet" id="googleSubForm" style="visibility: hidden;">
      <input type="text" name="Brainchop_Ver" id="Brainchop_Ver" />
      <input type="text" name="Country" id="Country" />
      <input type="text" name="State" id="State" />
      <input type="text" name="City" id="City" />
      <input type="text" name="Date" id="Date" />
      <input type="text" name="Time" id="Time" />
      <input type="text" name="File_Name" id="File_Name" />
      <input type="text" name="File_Type" id="File_Type" />
      <input type="text" name="File_Verified" id="File_Verified" />
      <input type="text" name="Img_Size" id="Img_Size" />

      <input type="number" step=any name="Num_Bits_Per_Voxel" id="Num_Bits_Per_Voxel" />
      <input type="number" step=any name="Data_Type_Code" id="Data_Type_Code" />
      <input type="number" step=any name="Vox_Offset" id="Vox_Offset" />
      <input type="text" name="Vox_1mm" id="Vox_1mm" />
      <input type="text" name="Resampled" id="Resampled" />

      <input type="text" name="Input_Shape" id="Input_Shape" />
      <input type="text" name="Output_Shape" id="Output_Shape" />
      <input type="text" name="Channel_Last" id="Channel_Last" />
      <input type="number" step=any name="Model_Param" id="Model_Param" />
      <input type="number" step=any name="Model_Layers" id="Model_Layers" />
      <input type="number" step=any name="No_SubVolumes" id="No_SubVolumes" />
      <input type="number" step=any name="Actual_Labels" id="Actual_Labels" />
      <input type="number" step=any name="Expect_Labels" id="Expect_Labels" />
      <input type="text" name="NumLabels_Match" id="NumLabels_Match" />
      <input type="number" step=any name="Data_Load" id="Data_Load" />
      <input type="number" step=any name="Preprocess_t" id="Preprocess_t" />
      <input type="number" step=any name="Inference_t" id="Inference_t" />
      <input type="number" step=any name="Merge_t" id="Merge_t" />
      <input type="number" step=any name="Postprocess_t" id="Postprocess_t" />
      <input type="text" name="Model" id="Model" />
      <input type="text" name="Browser" id="Browser" />
      <input type="number" step=any name="Browser_Ver" id="Browser_Ver" />
      <input type="text" name="OS" id="OS" />
      <input type="number" step=any name="Texture_Size" id="Texture_Size" />
      <input type="number" step=any name="Heap_Size_MB" id="Heap_Size_MB" />
      <input type="number" step=any name="Used_Heap_MB" id="Used_Heap_MB" />
      <input type="number" step=any name="Heap_Limit_MB" id="Heap_Limit_MB" />
      <input type="text" name="Status" id="Status" />
      <input type="text" name="WebGL1" id="WebGL1" />
      <input type="text" name="WebGL2" id="WebGL2" />
      <input type="text" name="TF_Backend" id="TF_Backend" />
      <input type="text" name="GPU_Vendor" id="GPU_Vendor" />
      <input type="text" name="GPU_Card" id="GPU_Card" />
      <input type="text" name="GPU_Vendor_Full" id="GPU_Vendor_Full" />
      <input type="text" name="GPU_Card_Full" id="GPU_Card_Full" />
      <input type="text" name="Error_Type" id="Error_Type" />
      <input type="text" name="Extra_Err_Info" id="Extra_Err_Info" />
      <input type="text" name="Extra_Info" id="Extra_Info" />
      <input type="number" step=any name="CPU_Cores" id="CPU_Cores" />
      <input type="submit" id="SubmitStatisticalData" />
    </form>
  </div>

  <!-- Credit for github logo: https://github.com/tholman/github-corners -->
  <a href="https://github.com/neuroneural/brainchop" style="cursor: pointer;" target='_blank'>
    <svg width="80" height="80" viewBox="0 0 250 250"
      style="position: absolute; top: 0px; right: 0px; border: 0px; cursor: pointer; " aria-hidden="true">
      <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" fill="#151513" style="cursor: pointer;"></path>
      <path
        d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
        fill="#ffffff" style="transform-origin: 130px 106px; cursor: pointer;"></path>
      <path
        d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
        fill="#ffffff" style="cursor: pointer;"></path>
    </svg>
  </a>

</body>

</html>